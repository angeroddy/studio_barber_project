name: Deploy

on:
  workflow_run:
    workflows:
      - CI
    types:
      - completed
  workflow_dispatch:

concurrency:
  group: deploy-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: read

jobs:
  deploy:
    if: >-
      ${{
        github.event_name == 'workflow_dispatch' ||
        (
          github.event_name == 'workflow_run' &&
          github.event.workflow_run.conclusion == 'success' &&
          (
            github.event.workflow_run.head_branch == 'main' ||
            github.event.workflow_run.head_branch == 'master'
          )
        )
      }}
    name: Deploy ${{ matrix.app.name }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        app:
          - name: backend_fresha
            secretName: BACKEND_DEPLOY_WEBHOOK
          - name: fresha_clone_sb
            secretName: DASHBOARD_DEPLOY_WEBHOOK
          - name: front_client_sb
            secretName: FRONT_CLIENT_DEPLOY_WEBHOOK

    steps:
      - name: Trigger deployment webhook
        if: ${{ secrets[matrix.app.secretName] != '' }}
        run: |
          curl --fail --show-error --silent \
            -X POST \
            "${{ secrets[matrix.app.secretName] }}"
          echo "Deployment triggered for ${{ matrix.app.name }}"

      - name: Skip app deployment when webhook secret is missing
        if: ${{ secrets[matrix.app.secretName] == '' }}
        run: |
          echo "::warning::Secret ${{ matrix.app.secretName }} is not set. Skipping ${{ matrix.app.name }} deploy."
